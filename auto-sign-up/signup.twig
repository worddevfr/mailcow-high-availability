{% extends 'base.twig' %}

{% block navbar %}{% endblock %}

{% block content %}
<div class="row mb-4" style="margin-top: 60px">
  <div class="col-12 col-md-7 col-lg-6 col-xl-5 ms-auto me-auto">

    <div class="card">
      <div class="card-header d-flex align-items-center text-break">
        <i class="bi bi-person-plus-fill me-2"></i> {{ lang.signup.create_account }}
        <div class="ms-auto form-check form-switch my-auto d-flex align-items-center">
          <label class="form-check-label"><i class="bi bi-moon-fill"></i></label>
          <input class="form-check-input ms-2" type="checkbox" id="dark-mode-toggle">
        </div>
        <div class="ms-4 d-grid d-sm-block">
          <button type="button" {% if available_languages|length == 1 %}disabled="true"{% endif %} class="text-secondary btn p-0 border-0 bg-transparent ms-auto dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="flag-icon flag-icon-{{ mailcow_locale[-2:] }}"></span>
          </button>
          <ul class="dropdown-menu ms-auto login">
            {% for key, val in available_languages %}
              <li>
                <a class="dropdown-item {% if mailcow_locale == key %}active{% endif %}" href="?{{ query_string({'lang': key}) }}">
                  <span class="flag-icon flag-icon-{{ key[-2:] }}"></span>{{ val }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="card-body">
        <div class="text-center mailcow-logo mb-4">
          <img class="main-logo" src="{{ logo|default('/img/cow_mailcow.svg') }}" alt="mailcow" height="200" width="200">
          <img class="main-logo-dark" src="{{ logo_dark|default('/img/cow_mailcow.svg') }}" alt="mailcow-logo-dark" height="200" width="200">
        </div>

        {% if success_message %}
          <div class="alert alert-success">{{ lang.signup.register_success }}</div>
        {% endif %}

        {% if error_message %}
          <div class="alert alert-danger">{{ error_message }}</div>
        {% endif %}

        <form id="signup-form" method="post" action="/signup.php">
          <div class="d-flex mt-3">
            <div class="input-group">
              <div class="input-group-text"><i class="bi bi-person-fill"></i></div>
              <input name="name" type="text" class="form-control" placeholder="{{ lang.signup.full_name }}" required="" autofocus="" value="{{ form_data.name|default('') }}" maxlength="50">
            </div>
          </div>

          <div class="input-group mt-3">
            <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
            <input name="local_part" type="text" class="form-control" placeholder="{{ lang.signup.mailbox_username }}" required="" value="{{ form_data.local_part|default('') }}" maxlength="50">
            
            {% if list_domains|length == 1 %}
              <input type="text" class="form-control" value="@{{ list_domains[0] }}" readonly style="flex-grow: 0.5;">
              <input type="hidden" name="domain" value="{{ list_domains[0] }}">
            {% else %}
              <select name="domain" class="selectpicker" data-width="auto">
                {% for domain in list_domains %}
                  <option value="{{ domain }}" {% if form_data.domain == domain %}selected{% endif %}>@{{ domain }}</option>
                {% endfor %}
              </select>
            {% endif %}
          </div>

          <div class="text-left mt-3 text-muted" style="font-size: 0.9rem;">
            <p class="help-block small">
              {{ local_part_policy|raw }}
            </p>
          </div>

          <div class="text-center mt-3">
            <a href="javascript:;" class="btn btn-outline-primary generate_password" id="generatePasswordBtn">
              <i class="bi bi-shuffle me-1"></i> {{ lang.signup.generate }}
            </a>
          </div>

          <div class="row g-2 mt-3 align-items-center">
            <div class="col position-relative">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                <input name="password1" id="password1" type="password" class="form-control" placeholder="{{ lang.signup.password }}" required autocomplete="new-password" maxlength="50">
                <button type="button" class="btn btn-outline-secondary" id="togglePassword1" style="position:absolute; right:0; top:0; height:100%; border:none; border-left:1px solid #ccc;">
                  <i class="bi bi-eye-fill"></i>
                </button>
              </div>
            </div>

            <div class="col-auto">
              <button type="button" id="copyPassword" class="btn btn-secondary" title="{{ lang.signup.generate }}" disabled>
                <i class="bi bi-clipboard fw-bold"></i>
              </button>
            </div>

            <div class="col position-relative">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                <input name="password2" id="password2" type="password" class="form-control" placeholder="{{ lang.signup.password_repeat }}" required autocomplete="new-password" maxlength="50">
                <button type="button" class="btn btn-outline-secondary" id="togglePassword2" style="position:absolute; right:0; top:0; height:100%; border:none; border-left:1px solid #ccc;">
                  <i class="bi bi-eye-fill"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="text-left mt-3 text-muted" style="font-size: 0.9rem;">
            {{ password_policy_html|raw }}
          </div>

          <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response" value="">

          <div class="d-flex justify-content-between mt-4" style="position: relative">
            <button type="submit" class="btn btn-xs-lg btn-success w-100 mt-2 mx-auto" style="max-width: 400px;" value="{{ lang.signup.register }}">{{ lang.signup.register }}</button>
          </div>
        </form>

        {% if custom_login.hide_admin_quicklink != 1 or custom_login.hide_domainadmin_quicklink != 1 or custom_login.hide_user_quicklink != 1 %}
          <div class="hr-title"><strong>{{ lang.login.other_logins }}</strong></div>
          <p class="text-center mt-3 text-muted" style="font-size: 0.9rem;">
            {{ lang.login.login_linkstext }}<br> 
            {% if custom_login.hide_user_quicklink != 1 %}<a href="/">{{ lang.login.login_usertext }}</a>{% endif %}
            {% if custom_login.hide_user_quicklink != 1 and (custom_login.hide_admin_quicklink != 1 or custom_login.hide_domainadmin_quicklink != 1) %}|{% endif %}
            {% if custom_login.hide_admin_quicklink != 1 %}<a href="/admin">{{ lang.login.login_admintext }}</a>{% endif %}
            {% if custom_login.hide_admin_quicklink != 1 and custom_login.hide_domainadmin_quicklink != 1 %}|{% endif %}
            {% if custom_login.hide_domainadmin_quicklink != 1 %}<a href="/domainadmin">{{ lang.login.login_domainadmintext }}</a>{% endif %}
          </p>
        {% else %}
          <p>&nbsp;</p>
        {% endif %}

      </div>
    </div>
  </div>
</div>

<script>
function generateEmailFromName(name) {
  if (!name) return '';
  name = name.trim();
  if (name.length < 5) return '';
  let localPart = name.toLowerCase();
  localPart = localPart.replace(/[^a-z0-9._-]/g, '.');
  localPart = localPart.replace(/([._-]){2,}/g, '$1');
  localPart = localPart.replace(/([a-z0-9])\1{3,}/g, '$1$1$1');
  if (!/^[a-z0-9]/.test(localPart)) localPart = 'u' + localPart;
  if (/^\d+$/.test(localPart)) localPart = 'user' + localPart;
  if (!/[a-z0-9]$/.test(localPart)) {
    localPart = localPart.replace(/[._-]+$/, '');
    if (!/[a-z0-9]$/.test(localPart)) localPart += '0';
  }
  if (localPart.length > 50) localPart = localPart.substring(0, 50);
  return localPart;
}

const nameInput = document.querySelector('input[name="name"]');
const emailInput = document.querySelector('input[name="local_part"]');
nameInput.addEventListener('input', () => {
  const generated = generateEmailFromName(nameInput.value);
  emailInput.value = generated ? generated : '';
});
</script>

<script>
const generateBtn = document.getElementById('generatePasswordBtn');
generateBtn.addEventListener('click', () => {
  const originalContent = generateBtn.innerHTML;
  generateBtn.innerHTML = '<i class="bi bi-check-lg me-1 text-success"></i> {{ lang.signup.generated|default("Ok") }}';
  setTimeout(() => {
    generateBtn.innerHTML = originalContent;
  }, 3000);
});
</script>

<script>
const passwordFields = [document.getElementById('password1'), document.getElementById('password2')];
const toggleButtons = [document.getElementById('togglePassword1'), document.getElementById('togglePassword2')];
const copyBtn = document.getElementById('copyPassword');
const generateLinks = document.querySelectorAll('.generate_password');

function togglePasswords() {
  const isPassword = passwordFields[0].type === 'password';
  passwordFields.forEach(f => f.type = isPassword ? 'text' : 'password');
  toggleButtons.forEach(btn => {
    btn.innerHTML = isPassword ? '<i class="bi bi-eye-slash-fill text-danger"></i>' : '<i class="bi bi-eye-fill"></i>';
  });
}
toggleButtons.forEach(btn => btn.addEventListener('click', togglePasswords));

passwordFields[0].addEventListener('input', () => {
  if (passwordFields[0].value.length >= 6) {
    copyBtn.disabled = false;
    copyBtn.classList.replace('btn-secondary', 'btn-success');
  } else {
    copyBtn.disabled = true;
    copyBtn.classList.replace('btn-success', 'btn-secondary');
  }
});

copyBtn.addEventListener('click', () => {
  navigator.clipboard.writeText(passwordFields[0].value).then(() => {
    copyBtn.innerHTML = '<i class="bi bi-check-lg fw-bold"></i>';
    copyBtn.classList.replace('btn-success', 'btn-primary');
    setTimeout(() => {
      copyBtn.innerHTML = '<i class="bi bi-clipboard fw-bold"></i>';
      copyBtn.classList.replace('btn-primary', 'btn-success');
    }, 1500);
  });
});

function generatePassword(length = 15) {
  const upper = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const lower = "abcdefghijklmnopqrstuvwxyz";
  const digits = "0123456789";
  const special = "!@#$%^&*()_-+=<>?";
  const all = upper + lower + digits + special;
  let pw = [];
  pw.push(upper[Math.floor(Math.random() * upper.length)]);
  pw.push(lower[Math.floor(Math.random() * lower.length)]);
  pw.push(digits[Math.floor(Math.random() * digits.length)]);
  pw.push(special[Math.floor(Math.random() * special.length)]);
  for (let i = pw.length; i < length; i++) {
    pw.push(all[Math.floor(Math.random() * all.length)]);
  }
  for (let i = pw.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [pw[i], pw[j]] = [pw[j], pw[i]];
  }
  return pw.join('');
}

generateLinks.forEach(link => {
  link.addEventListener('click', () => {
    const pw = generatePassword();
    passwordFields.forEach(f => f.value = pw);
    passwordFields[0].dispatchEvent(new Event('input'));
  });
});
</script>

<script src="https://www.google.com/recaptcha/api.js?render={{ recaptcha_site_key }}"></script>
<script>
grecaptcha.ready(function() {
  document.getElementById('signup-form').addEventListener("submit", function(e) {
    e.preventDefault();
    grecaptcha.execute('{{ recaptcha_site_key }}', {action: 'signup'}).then(function(token) {
      document.getElementById('g-recaptcha-response').value = token;
      e.target.submit();
    });
  });
});
</script>

{% endblock %}


